<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="Product">

  <typeAlias alias="Product"
             type="no.studios.atelier.data.DefaultProduct"
             />

  <resultMap id="product-result" class="Product">
    <result property="id" column="id"/>
    <result property="name" column="name"/>
    <result property="creationDate"
            column="creation_date"
            javaType="java.util.Date"/>
    <result property="price" column="price"/>
    <result property="description" column="description"/>
    <result property="productionTime" column="production_time"/>
    <result property="productType"
            column="product_type_id"
            select="getProductTypeById"/>
  </resultMap>

  <sql id="product-field-list">
    id,
    name,
    creation_date,
    price,
    description,
    production_time,
    product_type_id
  </sql>

  <select id="get-product-by-id"
          parameterClass="integer"
          resultMap="product-result">
    select <include refid="product-field-list"/>
    from product
    where id=#id#
  </select>

  <select id="get-all-products" resultMap="product-result">
    select <include refid="product-field-list"/>
    from product
  </select>

  <select id="get-all-products-of-type" resultMap="product-result">
    select <include refid="product-field-list"/>
    from product
    where product_type_id=#productTypeId#
  </select>

  <select id="get-last-product-id" resultClass="integer">
    select max(id) from product
  </select>

  <insert id="insert-product" parameterClass="Product">
    insert into product
    (
    name,
    price,
    creation_date,
    production_time
    <isNotNull property="productType">
      , product_type_id
    </isNotNull>
    <isNotNull property="description">
      , description
    </isNotNull>
    )

    values
    (
    #name#,
    #price#,
    #creationDate:TIMESTAMP#,
    #productionTime#
    <isNotNull property="productType">
      , #productType.id#
    </isNotNull>
    <isNotNull property="description">
      , #description#
    </isNotNull>
    )

    <selectKey keyProperty="id">
      select max(id) from product
    </selectKey>
  </insert>

  <!-- updates a tip product -->
  <update id="update-product" parameterClass="Product">
    update product
    set name=#name#,
    price=#price#,
    production_time=#productionTime#
    <isNotNull property="productType">
      , product_type_id=#productType.id:INTEGER#
    </isNotNull>
    <isNotNull property="description">
      , description=#description#
    </isNotNull>
    where id=#id#
  </update>

  <delete id="deleteProduct" parameterClass="integer">
    delete from product where id=#id#
  </delete>

</sqlMap>
