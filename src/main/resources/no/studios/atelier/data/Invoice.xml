<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap
PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="Invoice">

  <typeAlias alias="Invoice"
             type="no.studios.atelier.data.DefaultInvoice"/>

  <resultMap id="invoice-result" class="Invoice">
    <result property="id" column="id"/>
    <result property="creationDate"
            column="creation_date"
            javaType="java.util.Date"/>
    <result property="order"
            column="order_id"
            select="getCustomerOrderById"/>
    <result property="dueDate"
            column="due_date"
            javaType="java.util.Date"
            />
    <result property="taxIncluded"
            column="tax_included"
            javaType="boolean"
            jdbcType="SMALLINT"
            />
    <result property="order"
            column="order_id"
            select="getCustomerOrderById"
            />
  </resultMap>
  <!--iBATIS automatically converts SMALLINT into boolean-->


  <parameterMap id="invoice-param" class="Invoice">
    <parameter property="id"/>
    <parameter property="order.id" />
    <parameter property="dueDate"
               javaType="java.util.Date"
               jdbcType="Timestamp"
               />
    <parameter property="taxIncluded"
               javaType="boolean"
               jdbcType="SMALLINT"
               />
  </parameterMap>
  <!-- iBATIS automatically converts boolean into SMALLINT-->

  <sql id="invoice-field-list">
    id,
    creation_date,
    order_id,
    due_date,
    tax_included
  </sql>

  <!-- Select with no parameters using the result map for
       Invoice class. -->
  <select id="getAllInvoices"
          parameterClass="int"
          resultMap="invoice-result">
    select
    <include refid="invoice-field-list"/>
    from invoice
    where customer_id = #id#
  </select>

  <select id="getAllInvoiceIds" resultClass="integer">
    select id from invoice
  </select>

  <select id="get-invoice-list-in-date-range"
          parameterClass="java.util.Map"
          resultMap="invoice-result">
    select
    <include refid="invoice-field-list"/>
    from invoice
    where creation_date between #fromDate# and #toDate#
    order by creation_date asc
  </select>

  <select id="get-last-invoice-id" resultClass="integer">
    select max(id) from invoice
  </select>

  <select id="get-order-id-by-invoice-id" resultClass="integer">
    select order_id from invoice where id = #invoiceId#
  </select>

  <select id="get-invoice-id-by-order-id" resultClass="integer">
    select id from invoice where order_id = #orderId#
  </select>

  <select id="get-invoice-by-id"
          parameterClass="int"
          resultMap="invoice-result">
    select <include refid="invoice-field-list" />
    from invoice
    where id = #id#
  </select>

  <insert id="insert-invoice" parameterClass="Invoice">
    insert into invoice
    (
    <isNotNull property="order">
      order_id,
    </isNotNull>
    creation_date,
    due_date,
    tax_included
    )

    values
    (
    <isNotNull property="order">
      #order.id#,
    </isNotNull>
    #creationDate:TIMESTAMP#,
    #dueDate:TIMESTAMP#,
    #taxIncluded#
    )

    <selectKey keyProperty="id">
      select max(id) from invoice
    </selectKey>
  </insert>

  <delete id="delete-invoice" parameterClass="integer">
    delete from invoice where id=#id#
  </delete>

  <update id="update-invoice" parameterClass="Invoice">
    update invoice
    set
    <isNotNull property="order">
      order_id=#order.id#,
    </isNotNull>
    due_date=#dueDate:TIMESTAMP#,
    tax_included=#taxIncluded#
    where id=#id#
  </update>

</sqlMap>
