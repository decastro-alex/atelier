<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="Comment">

  <typeAlias alias="Comment" type="no.studios.atelier.data.DefaultComment" />

  <resultMap id="commentResult" class="Comment">
    <result property="id" column="id"/>
    <result property="comment" column="comment"/>
    <result property="creationDate" column="creation_date"/>
    <result property="user" column="user_id" select="getUserById" />
    <!--
        causes getComment(id) to hang, endless recursion?

<result property="customerOrder"
column="order_id"
select="getCustomerOrderById" />
    -->
    <result property="orderId" column="order_id" />
  </resultMap>

  <sql id="commentFieldList">
    id, comment, creation_date, user_id, order_id
  </sql>

  <!-- retrieve a comment on its own id -->
  <select id="getCommentById"
          parameterClass="integer"
          resultMap="commentResult">
    select <include refid="commentFieldList"/>
    from order_comment
    where id=#id#
  </select>

  <!-- retrieves comments that a user has made -->
  <select id="getCommentsByUserId" parameterClass="integer" resultMap="commentResult">
    select <include refid="commentFieldList"/>
    from order_comment
    where user_id=#id#
  </select>

  <!-- retrieves comments that a user has made -->
  <select id="getCommentsByOrderId"
          parameterClass="integer"
          resultMap="commentResult">
    select <include refid="commentFieldList"/>
    from order_comment
    where order_id=#id#
  </select>

  <insert id="insertComment" parameterClass="Comment">
    insert into order_comment
    (
    comment,
    creation_date,
    order_id
    <isNotNull property="user">
      , user_id
    </isNotNull>
    )

    values
    (
    #comment#,
    #creationDate#,
    #orderId#
    <isNotNull property="user">
      , #user.id#
    </isNotNull>
    )

    <selectKey keyProperty="id">
      select max(id) from order_comment
    </selectKey>
  </insert>

  <!-- updates a tip comment -->
  <update id="updateComment" parameterClass="Comment">
    update order_comment
    set comment=#comment#,
    creation_date=#creationDate#,
    order_id=#orderId#
    <isNotNull property="user">
      , user_id=#user.id#
    </isNotNull>
    where id=#id#
  </update>

  <delete id="deleteComment" parameterClass="integer">
    delete from order_comment where id=#id#
  </delete>

  <delete id="deleteCommentByUserId" parameterClass="integer">
    delete from order_comment where user_id=#id#
  </delete>

  <delete id="deleteCommentByOrderId" parameterClass="integer">
    delete from order_comment where order_id=#id#
  </delete>

</sqlMap>
