<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap
PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="User">

  <typeAlias alias="User" type="no.studios.atelier.data.DefaultUser"/>

  <resultMap id="userResult" class="User">
    <result property="id" column="id"/>
    <result property="userName" column="user_name"/>
    <result property="firstName" column="first_name"/>
    <result property="lastName" column="last_name"/>
    <result property="encryptedPassword" column="encrypted_password"/>
    <result property="creationDate" column="creation_date"
            javaType="java.util.Date"/>
    <result property="address" column="address"/>
    <result property="postCode" column="post_code"/>
    <result property="homePhone" column="home_phone"/>
    <result property="mobilePhone" column="mobile_phone"/>
    <result property="workPhone" column="work_phone"/>
    <result property="emailAddress" column="email_address"/>
    <result property="birthDate" column="birth_date"
            javaType="java.util.Date"/>
  </resultMap>
  <!--iBATIS automatically converts SMALLINT into boolean-->


  <parameterMap id="userParam" class="User">
    <parameter property="id"/>
    <parameter property="userName"
               jdbcType="varchar"
               nullValue=""
               javaType="java.lang.String"/>
    <parameter property="firstName"
               jdbcType="varchar"
               nullValue=""
               javaType="java.lang.String"/>
    <parameter property="lastName"
               jdbcType="varchar"
               nullValue=""
               javaType="java.lang.String"/>
    <parameter property="encryptedPassword" jdbcType="varbianry"/>
    <parameter property="creationDate" javaType="java.util.Date"/>
    <parameter property="address" javaType="java.lang.String" />
    <parameter property="postCode" javaType="java.lang.String"/>
    <parameter property="homePhone" javaType="java.lang.String"/>
    <parameter property="mobilePhone" javaType="java.lang.String"/>
    <parameter property="workPhone" javaType="java.lang.String"/>
    <parameter property="emailAddress" javaType="java.lang.String"/>
    <parameter property="birthDate" javaType="java.util.Date"/>
  </parameterMap>

  <sql id="userFieldList">
    user.id,
    user_name,
    first_name,
    last_name,
    encrypted_password,
    creation_date,
    address,
    post_code,
    home_phone,
    mobile_phone,
    work_phone,
    email_address,
    birth_date
  </sql>

  <!-- Select with name part parameter using the result map for User class. -->

  <select id="searchUserByAnyNamePart"
          resultMap="userResult"
          parameterClass="java.lang.String">
    select distinct
    <include refid="userFieldList"/>
    from user
    where
    user_name LIKE #value#
    OR
    first_name LIKE #value#
    OR
    last_name LIKE #value#
    OR
    CONCAT(CONCAT(first_name,' '), last_name) LIKE #value#
  </select>

  <!-- Select with no parameters using the result map for User class. -->
  <select id="getAllUsers" resultMap="userResult">
    select
    <include refid="userFieldList"/>
    from user
  </select>

  <select id="getAllUserIds" resultClass="integer">
    select id from user
  </select>

  <!-- Select with no parameters using the result map for User class. -->
  <select id="getAllUserNames" resultClass="java.lang.String">
    select user_name from user
  </select>

  <select id="authenticateUser" parameterClass="java.util.Map" resultMap="userResult">
    select
    <include refid="userFieldList" />
    from user
    where user_name=#userName#
    and encrypted_password=#encryptedPassword:VARCHAR FOR BIT DATA#
  </select>

  <select id="getUserById" parameterClass="int" resultMap="userResult">
    select
    <include refid="userFieldList" />
    from user
    where id = #id#
  </select>

  <select id="getUserByName" parameterClass="java.lang.String" resultMap="userResult">
    select
    <include refid="userFieldList" />
    from user
    where user_name = #id#
  </select>

  <!-- query to retrieve a user by its first_name column -->
  <select id="getUsersByFirstName"
          parameterClass="java.lang.String"
          resultMap="userResult">
    select
    <include refid="userFieldList" />
    from user
    where lower(first_name) = lower(#value#)
  </select>

  <!-- query to retrieve a user by its last_name column -->
  <select id="getUsersByLastName"
          parameterClass="java.lang.String"
          resultMap="userResult">
    select
    <include refid="userFieldList" />
    from user
    where lower(last_name) = lower(#value#)
  </select>

  <!-- query to retrieve a user by its mobile_phone column -->
  <select id="getUsersByMobileNo"
          parameterClass="java.lang.String"
          resultMap="userResult">
    select
    <include refid="userFieldList" />
    from user
    where mobile_phone = #value:VARCHAR#
  </select>

  <!-- query to retrieve a user by its phone (work_phone or
       home_phone) column -->
  <select id="getUsersByHomePhone"
          parameterClass="java.lang.String"
          resultMap="userResult">
    select
    <include refid="userFieldList" />
    from user
    where home_phone = #value:VARCHAR#
  </select>

  <!-- query to retrieve a user by its phone (work_phone) column -->
  <select id="getUsersByWorkPhone"
          parameterClass="java.lang.String"
          resultMap="userResult">
    select
    <include refid="userFieldList" />
    from user
    where work_phone = #value:VARCHAR#
  </select>

  <!-- query to retrieve a user by its phone (work_phone or
       home_phone) column -->
  <select id="getUsersByPhone"
          parameterClass="java.lang.String"
          resultMap="userResult">
    select
    <include refid="userFieldList" />
    from user
    where home_phone = #value:VARCHAR#
    or work_phone = #value:VARCHAR#
    or mobile_phone = #value:VARCHAR#
  </select>

  <!-- query to retrieve a user by its email_address column -->
  <select id="getUsersByEmail"
          parameterClass="java.lang.String"
          resultMap="userResult">
    select
    <include refid="userFieldList" />
    from user
    where email_address = #value#
  </select>

  <!-- query to retrieve a user by its email_address column -->
  <select id="getUserByFirstNameLastName"
          parameterClass="java.util.Map"
          resultMap="userResult">
    select
    <include refid="userFieldList" />
    from user
    where lower(first_name) = lower(#firstName#)
    and lower(last_name) = lower(#lastName#)
  </select>

  <!-- query to retrieve a list of user by a group id -->
  <select id="getAuthenticatedUser"
          parameterClass="java.util.Map"
          resultMap="userResult">
    select
    <include refid="userFieldList" />
    from user where
    user_name=#userName#
    and encrypted_password=#encryptedPassword#
  </select>

  <insert id="insertUser" parameterClass="User">
    insert into user (user_name,
    first_name,
    last_name,
    encrypted_password,
    creation_date,
    address,
    post_code,
    home_phone,
    mobile_phone,
    work_phone,
    email_address,
    birth_date)
    values (#userName:VARCHAR#,
    #firstName:VARCHAR#,
    #lastName:VARCHAR#,
    #encryptedPassword:VARBINARY#,
    #creationDate:TIMESTAMP#,
    #address:VARCHAR#,
    #postCode:VARCHAR#,
    #homePhone:VARCHAR#,
    #mobilePhone:VARCHAR#,
    #workPhone:VARCHAR#,
    #emailAddress:VARCHAR#,
    #birthDate:TIMESTAMP#)
    <selectKey keyProperty="id">
      select max(id) from user
    </selectKey>
  </insert>


  <delete id="deleteUser" parameterClass="integer">
    delete from user where id=#id#
  </delete>


  <update id="updateUser" parameterClass="User">
    update user
    set user_name=#userName:VARCHAR#,
    first_name=#firstName#,
    last_name=#lastName#,
    encrypted_password=#encryptedPassword:VARCHAR FOR BIT DATA#,
    creation_date=#creationDate:TIMESTAMP#,
    address=#address:VARCHAR#, post_code=#postCode:VARCHAR#,
    home_phone=#homePhone:VARCHAR#,
    mobile_phone=#mobilePhone:VARCHAR#,
    work_phone=#workPhone:VARCHAR#,
    email_address=#emailAddress:VARCHAR#,
    birth_date=#birthDate:TIMESTAMP#
    where id=#id#
  </update>

</sqlMap>
